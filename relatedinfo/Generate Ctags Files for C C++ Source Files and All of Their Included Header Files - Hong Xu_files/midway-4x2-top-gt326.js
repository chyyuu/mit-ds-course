DISQUS.addBlocks("theme")(function(d){d.blocks.discoveryBoxHelp=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put('    <div class="alert">        <a class="close" data-action="discovery-help-close"/>\u00d7</a>        '),a.put(d.interpolate(gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),{learnMore:d.renderBlock("learnMore"),
feedback:d.renderBlock("feedback")})),a.put("    </div>"),a.compile()};d.blocks.feedback=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put('<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">    '),a.put(gettext("give us feedback")),a.put("</a>"),a.compile()};d.blocks.relatedThread=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put('    <li class="discovery-unit">        <div class="main publisher-anchor-color">            <h3 title="'),
a.put((a.esc||function(a){return a})(thread.title)),a.put('">                <a class="title"                href="'),a.put((a.esc||function(a){return a})(thread.redirectUrl)),a.put('"                '),external&&a.put('target="_blank"'),a.put(">"),a.put(thread.title),a.put("</a>            </h3>            "),external&&thread.forum&&thread.forum.name&&(a.put('            <span class="extra eo">'),a.put((a.esc||function(a){return a})(thread.forum.name)),a.put("</span>            ")),a.put('            <span class="extra">            '),
thread.posts?(a.put("                "),thread.posts===1?(a.put("                    "),a.put(gettext("1 comment"))):(a.put("                    "),a.put(d.interpolate(gettext("%(numPosts)s comments"),{numPosts:thread.posts}))),a.put("                ")):(a.put("                "),a.put((a.esc||function(a){return a})(thread.brand))),a.put("            "),a.put("            </span>        </div>    </li>"),a.compile()};d.blocks.learnMore=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put('<a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"   target="_blank">'),
a.put(gettext("Learn more")),a.put("</a>"),a.compile()};d.blocks.relatedThreads=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put('<div id="discovery-main" class="extra-links">    <div id="discovery-note" style="display:none;">        '),function(){var g={};d.extend(g,c);d.extend(g,{});a.put(d.renderBlock("discoveryBoxHelp",g))}(),a.put('    </div>    <div id="discovery-content-wrap">        <section id="discovery-external">            <header>                <div id="discovery-options">                    <span class="publisher-anchor-color"><a href="#" id="discovery-help" data-action="discovery-help">'),
a.put(gettext("What's this?")),a.put("</a></span>                    "),a.put("                </div>                <h2>"),a.put(gettext("Around the Web")),a.put("</h2>            </header>            <ul>                "),a.put('            </ul>        </section>        <section id="discovery-internal">            <header>                <h2>'),a.put(d.interpolate(gettext("Also on %(forumName)s"),{forumName:d.renderBlock("forumName",forum)})),a.put("</h2>            </header>            <ul>                "),
a.put("            </ul>        </section>    </div></div>"),a.compile()};d.blocks.forumName=function(j,c){var a=new d.Builder,f=DISQUS.extend({},j,c);with(f)return a.put("<strong>"),a.put((a.esc||function(a){return a})(name)),a.put("</strong>"),a.compile()}});
(function(d){var j=d.document,c=d.DISQUS;c.registerActions=function(){c.define("discovery.collections",function(){var a=!1;return{load:function(f,g){var e=c.discovery.collections;if(a)return e;var b=Backbone.Collection.extend({initialize:function(a,e){this.mainThread=e.thread;this.limit=e.limit;this.variant=e.variant||{};this.external=e.external},fetch:function(a){var e={};e.data={thread:this.mainThread.get("id")};e.parse=!1;_.extend(e,a);Backbone.Collection.prototype.fetch.call(this,e)},addBandit:function(a){if((a=
a.response)&&a.bandit)this.bandit=a.bandit},getBanditJSON:_.memoize(function(){return c.JSON.stringify(this.bandit)}),makeRedirect:function(a,e,n){var b=a?"http://redirect.disqus.com/url":e.link+"#redirect",a={url:a,imp:c.juggler.impId,zone:n.external?"external_discovery":"internal_discovery",forum:this.mainThread.get("forum").id,source_thread_id:this.mainThread.id};this.variant.isExperiment&&_.extend(a,{variant:this.variant.name});e.advertisement_id?_(a).extend({zone:"promoted_discovery",advertisement_id:e.advertisement_id,
body_id:e.body_id}):_(a).extend({thread:e.id});this.bandit&&_.extend(a,{bandit:this.getBanditJSON()});return c.serialize(b,a)}});e.RelatedThreadCollection=b.extend({model:f.RelatedThread,url:c.api.getURL("discovery/listRelated.json"),parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;var f=g.log,p=this.mainThread.get("forum");f(this.url,"results (",b.length,"):",b,"ids:",_.pluck(b,"id"));for(var d=0,j=b.length;d<j&&e.length<this.limit;d++)if(a=b[d].thread||b[d],
!c.debug&&a.id==this.mainThread.id)f("Thread",a.id,"is same as source thread.");else if(!c.debug&&a.posts===0)f("Thread",a.id,"does not have any comments.");else if(!c.debug&&a.title.indexOf("http://")===0)f("Thread",a.id,"has a title that starts with http.");else{a.score={score:b[d].score,k:b[d].k};if(a.signedUrl)a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:a.forum.id!=p.id});e.push(a)}f("Total results after pruning:",e.length);return e}});e.AdvertisementCollection=b.extend({model:f.Advertisement,
url:c.api.getURL("discovery/listPromoted.json"),external:!0,parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;g.log(this.url,"results (",b.length,"):",b,"ad_ids:",_.pluck(b,"advertisement_id"));for(var c=0,f=b.length;c<f&&e.length<this.limit;c++)a=b[c],a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:!0}),e.push(a);return e}});a=!0;return e}}});c.define("discovery",function(){return this.overwrites({init:function(a,f){function d(a,b,c,f,p){if(_.isNumber(f)&&
a.length<f)return void e();a=new z({el:b,collection:a});a.on("resize",function(){c.trigger("resize")});a.render(p||{});c.trigger("subViewRendered")}function e(e){e=e||{};if(!y){y=!0;var b=c.juggler.client("juggler");if(b){var f={major_version:"midway",internal_organic:k.length,external_organic:h.length,promoted:q.length,promoted_ids:c.JSON.stringify(q.pluck("advertisement_id")),display:!!e.display},d;if(w.bandit||q.bandit)d=_.extend({},w.bandit,q.bandit);d&&_.extend(f,{bandit:c.JSON.stringify(d)});
a.isExperiment&&_.extend(f,{variant:s});o("Juggler init_discovery",f);b.emit("init_discovery",f);r("dark_jester",function(){c.juggler.client("jester",!0).emit("init_discovery",f)})}}}var b=c.discovery.helpers,r=b.ifSwitch,o=b.log,n=a.switches,s=a.variant,p=a.session,u=a.forum,x=a.containerId;b.config(a.switches);var t=4,l=s.match(/(\d)x\d/);l&&(t=parseInt(l[1],10));var l=$("#"+a.loungeId),m=s.match(/^midway-4x2-top-gt(\d{1,3})$/);m&&(m=m[1],l.height()>m&&p.isAnonymous()&&u.settings.discoveryMax&&
n.enabled("discovery_next:top_placement")?x+="-top":t=6);var u=c.discovery.models.load(),l=c.discovery.collections.load(u,b),b=c.discovery.views.load(b),n=l.RelatedThreadCollection,z=b.RelatedThreadCollectionView,l=l.AdvertisementCollection,A=b.AdvertisementCollectionView,v=new u.Thread(_.extend(a.thread,{forum:a.forum})),t={thread:v,limit:t,variant:{isExperiment:!!a.isExperiment,name:s}},k=new n(null,t),h=new n(null,_.defaults({external:!0},t)),q=new l(null,_.defaults({external:!0},t)),u=[k,h,q];
_.invoke(u,"on","error",e);var i=new b.MainView({el:j.getElementById(x)});i.$el.css({position:"absolute",visibility:"hidden",display:"block"});i.$el.append(c.renderBlock(i.dtplBlock,{forum:v.get("forum"),variant:s,session:p.toJSON()}));p.on("change:canModerate",_.bind(i.renderHelp,i,p));_.invoke(u,"on","reset",function(){var a=0,e=0,b=!1;return function(c){b||(c.external?e+=c.length:a+=c.length,a<1||e<1||(b=!0,f(i)))}}());i.on("subViewRendered",_.after(1,function(){i.trigger("allSubviewsRendered");
e({display:!0})}));var w=new n(null,_.defaults({limit:k.limit+h.limit},t));w.fetch({data:{thread:v.id,limit:w.limit},success:function(a){if(a.length<1)return void e();var b=v.get("forum"),c;c=a.filter(function(a){return a.get("forum").id!=b.id});a=_.difference(a.models,c);k.reset(a.slice(0,k.limit)).each(function(a){a.collection=k});a=i.$el.find("#discovery-internal")[0];d(k,a,i,1,{start:0,limit:c.length});o("Internal organic",k.pluck("id"));h.reset(c.slice(0,h.limit)).each(function(a){a.collection=
h});h.fetched=!0;o("External organic",h.pluck("id"))},error:e});q.fetch({data:{thread:v.id,limit:q.limit},success:function(a){o("Promoted:",a.pluck("advertisement_id"));var b=i.$el.find("#discovery-external")[0],c=new A({el:b,collection:a}),f=function(){h.off("reset",f);if(k.length<1)return void e();var p=Math.min(k.length,a.limit),j=Math.min(k.limit,h.length+a.length);j>h.length&&d(k,i.$el.find("#discovery-internal")[0],i,1,{start:h.length,limit:j});h.length>0?(c.render({limit:p-1}),d(h,b,i,1-a.length,
{limit:Math.max(p-a.length,1)})):c.render({limit:p});a.length>=1&&i.trigger("subViewRendered")};if(h.fetched)f();else h.on("reset",f)},error:e});var y=!1}})});c.define("discovery.helpers",function(a,f){var d=null,e=!1,b=!1,r=function(){};a.console&&(r=function(){b&&(a.console.log.apply?a.console.log.apply(a.console,arguments):a.console.log(_.toArray(arguments).join(" ")))});var o=function(a){if(a===f)return b;b=!!a},n=function(a){if(a===f)return e;e=!!a},s=function(a,e,b){if(d)if(d.length)d.enabled(a)&&
e();else{var c=function(){d.enabled(a)&&e();b&&d.off("reset",c)};return void d.on("reset",c)}};return{config:function(a){d=a;n(!0);s("discovery_next:logging",function(){o(!0)})},allowLog:o,ifSwitch:s,log:r,allowLineTruncate:n,lineTruncate:function(b,f){function d(){return r.scrollHeight-r.offsetHeight>0.2*n}function g(){m.lastChild&&!_.contains(["...","\u2026"],m.lastChild.nodeValue)&&(k=m.appendChild(a.document.createTextNode(" "+o)),d()&&(m.removeChild(k),m.removeChild(m.lastChild),g()))}if(e){var l=
c.logError||function(){};if(!b.closest("body").length)return void l("lineTruncate called on el not on DOM");if(b.text().length<1)return void l("lineTruncated called on empty el");if(_.any(b.children(),function(a){return a.nodeType!==3}))return void l("lineTruncate called on non-flat el");var m=b[0],r=m;if(b.css("display")!=="block")for(;r.parentNode;)if(r=r.parentNode,$(r).css("display")==="block")break;var n=parseFloat(b.css("font-size"),10);if(d()){var f=f||{},l=f.lines||1,o=f.ellipsis,k,h=b.text();
if(h.length){var q=b.width()/n,l=parseInt(q*l,10),h=h.split(/\s/),q=0;b.empty();for(var i=0,s=h.length;i<s;i++){q+=h[i].length+1;if(q>=l)break;m.appendChild(j.createTextNode(" "+h[i]))}if(d()){do k=m.removeChild(m.lastChild);while(d())}else{do k=m.appendChild(j.createTextNode(" "+h[i++]));while(!d()&&i<s);m.removeChild(k)}o&&(_.isString(o)||(o="\u2026"),g())}}}}}});c.define("discovery.models",function(){var a=!1;return{load:function(){var d=c.discovery.models;if(a)return d;var g=d.Thread=Backbone.Model.extend({defaults:{author:null,
category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},url:c.api.getURL("threads/details"),parse:function(a){return a.response}});d.RelatedThread=g.extend({defaults:_.defaults({redirectUrl:null,topComment:null},g.prototype.defaults)});d.Advertisement=Backbone.Model.extend({idAttribute:"body_id",defaults:{brand:"",headline:"",text:"",url:"",advertisement_id:null,
body_id:null,redirectUrl:null},get:function(a){if(a==="title")return this.get("headline");return Backbone.Model.prototype.get.call(this,a)},toJSON:function(){var a=this.attributes;return{title:a.headline,brand:a.brand,redirectUrl:a.redirectUrl,link:a.url}}});a=!0;return d}}});c.define("discovery.views",function(){var a=!1;return{load:function(d){var g=c.discovery.views;if(a)return g;g.RelatedThreadView=Backbone.View.extend({events:{"click [data-redirect]":"swapLink"},dtplBlock:"relatedThread",swapLink:function(a){a=
a.target||a.srcElement;a.tagName.toUpperCase()=="A"&&a.getAttribute("data-redirect")||(a=$(a).closest("a[data-redirect]")[0]);var b=a;b.setAttribute("data-href",b.getAttribute("href"));b.setAttribute("href",b.getAttribute("data-redirect"));_.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},renderAvatar:function(a){var b=this.$el.find("[data-role=discovery-avatar]");b.attr("src",a.avatar.cache);b.attr("alt",this.authorName(a));return this},authorName:function(a){return a.name||
a.username},render:function(a){var a=a||{},b=a.parent,g=this.model.toJSON();if(!_.isObject(g.forum)&&_.isString(g.forum))g.forum={name:g.forum};this.setElement(c.renderBlock(this.dtplBlock,{thread:g,external:!!a.external,variant:this.model.collection.variant.name}));b.append(this.$el);d.lineTruncate(this.$el.find("h3 a.title"),{lines:2,ellipsis:!0});this.$el.find("h3, .extra").css({display:"inline"});return this}});g.RelatedThreadCollectionView=Backbone.View.extend({resize:_.debounce(function(){this.trigger("resize")},
500),render:function(a){var a=a||{},b=a.limit,c=_.isNumber(b),d=a.start,f=_.isNumber(d);this.collection.each(function(a,e){c&&e>=b||f&&e<d||(new g.RelatedThreadView({model:a})).on("resize",this.resize,this).render({parent:this.$el.find("ul"),external:!!this.collection.external})},this);return this}});g.AdvertisementCollectionView=Backbone.View.extend({render:function(a){var a=a||{},b=a.limit,c=_.isNumber(b);this.collection.each(function(a,d){c&&d>=b||(new g.RelatedThreadView({model:a})).render({parent:this.$el.find("ul"),
external:!0})},this);return this}});g.MainView=Backbone.View.extend({dtplBlock:"relatedThreads",events:{"click [data-action=discovery-close]":"close","click [data-action=discovery-help]":"showHelp","click [data-action=discovery-help-close]":"closeHelp"},close:function(a){a.preventDefault();this.remove();this.trigger("resize",0)},showHelp:function(a){a.preventDefault();$(a.currentTarget).hide();this.$el.find("#discovery-note").show();this.trigger("resize")},closeHelp:function(a){a&&a.preventDefault();
this.$el.find("#discovery-note").hide();this.trigger("resize")},renderHelp:function(a){this.closeHelp();this.$el.find("[data-action=discovery-help]").show();this.$el.find("#discovery-note").html(c.renderBlock("discoveryBoxHelp",{session:a.toJSON()}))},render:function(){this.$el.css({position:"static",visibility:"visible"});return this}});a=!0;return g}}})};c.runThemeScript=c.registerActions})(this);